provider "aws" {
  region = "us-east-1"
}

resource "aws_api_gateway_rest_api" "example" {
  name = "example-api"
}

{% for resource in resources %}
resource "aws_api_gateway_resource" "{{ resource.name }}" {
  rest_api_id = aws_api_gateway_rest_api.example.id
  parent_id   = {{ resource.parent_id }}
  path_part   = "{{ resource.path_part }}"
}
{% endfor %}

{% for method in methods %}
resource "aws_api_gateway_method" "{{ method.http_method | lower }}_{{ method.resource_name }}" {
  rest_api_id   = aws_api_gateway_rest_api.example.id
  resource_id   = {{ method.resource_id }}
  http_method   = "{{ method.http_method | upper }}"
  authorization = "NONE"
}
{% endfor %}

resource "aws_api_gateway_deployment" "example" {
  depends_on = [
    {% for method in methods %}
    aws_api_gateway_method.{{ method.http_method | lower }}_{{ method.resource_name }}{% if not loop.last %}, {% endif %}
    {% endfor %}
  ]
  rest_api_id = aws_api_gateway_rest_api.example.id
  stage_name  = "prod"
}
